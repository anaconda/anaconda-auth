from functools import cached_property
from typing import Any

import httpx

from anaconda_auth.client import BaseClient


# add BaseClient superclass to pick up properties
class AsyncBaseClient(httpx.AsyncClient, BaseClient):  # type: ignore
    """Version of client.BaseClient for use in async contexts."""

    def __init__(self, **kwargs) -> None:
        # require sync client to set up initial config, since this client could
        # be instantiated in sync code.
        sync_client = BaseClient(**kwargs)
        self._account = sync_client.account
        self.config = sync_client.config
        self.api_version = sync_client.api_version

        super().__init__(
            headers=sync_client.headers,
            verify=sync_client._ssl,
            cert=sync_client.config.client_cert,
            base_url=sync_client._base_uri,
            auth=sync_client.auth,
        )

    @cached_property
    def account(self) -> dict:
        return self._account

    async def request(
        self,
        method: str,
        url: httpx.URL | str,
        *args: Any,
        **kwargs: Any,
    ) -> httpx.Response:
        kwargs["timeout"] = 600
        response = await super().request(method, url, *args, **kwargs)

        min_api_version_string = response.headers.get("Min-Api-Version")
        self._validate_api_version(min_api_version_string)

        return response
